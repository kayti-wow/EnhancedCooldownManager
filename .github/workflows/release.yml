name: Package Release

on:
  push:
    tags:
      - 'v*'

env:
  ADDON_NAME: EnhancedCooldownManager
  CF_PROJECT_ID: 1427906

jobs:
  package:
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version and changelog
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Packaging version: $VERSION"

          # Generate changelog from commits since previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${VERSION}^" 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to $VERSION"
            CHANGELOG=$(git log --pretty=format:"- %s" "${PREVIOUS_TAG}..${VERSION}" 2>/dev/null || echo "")
          else
            echo "No previous tag found, using all commits up to $VERSION"
            CHANGELOG=$(git log --pretty=format:"- %s" "${VERSION}" 2>/dev/null || echo "")
          fi

          # Handle empty changelog
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Release ${VERSION}"
          fi

          echo "$CHANGELOG" > changelog.txt
          echo "Changelog:"
          cat changelog.txt

      - name: Create package directory
        run: |
          mkdir -p package/${ADDON_NAME}

      - name: Copy addon files
        run: |
          rsync -av --progress . package/${ADDON_NAME}/ \
            --exclude '.*' \
            --exclude 'TODO.md' \
            --exclude 'CLAUDE.md' \
            --exclude '*.code-workspace' \
            --exclude '.vscode' \
            --exclude '.idea' \
            --exclude 'package'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ADDON_NAME }}-${{ steps.version.outputs.version }}
          path: package

      - name: Create zip for CurseForge
        run: |
          cd package
          zip -r ../${ADDON_NAME}-${{ steps.version.outputs.version }}.zip ${ADDON_NAME}

      - name: Upload to CurseForge
        env:
          CF_TOKEN: ${{ secrets.CF_TOKEN }}
        run: |
          # Determine release type from version string
          VERSION="${{ steps.version.outputs.version }}"
          if [[ "$VERSION" == *"-alpha"* ]]; then
            RELEASE_TYPE="alpha"
          elif [[ "$VERSION" == *"-beta"* ]]; then
            RELEASE_TYPE="beta"
          else
            RELEASE_TYPE="release"
          fi

          # Extract Interface versions from .toc file (e.g., "120000, 120001, 110207")
          TOC_INTERFACES=$(grep -oP '## Interface: \K.*' ${ADDON_NAME}.toc | tr -d '[:space:]')
          echo "TOC Interface versions: $TOC_INTERFACES"

          # Fetch game versions from CurseForge API (requires auth)
          CF_VERSIONS=$(curl -s -H "X-Api-Token: ${CF_TOKEN}" "https://wow.curseforge.com/api/game/versions")

          # Match by apiVersion and verify all TOC versions are mapped
          # Filter to only objects that have apiVersion field
          RESULT=$(echo "$CF_VERSIONS" | jq -c --arg interfaces "$TOC_INTERFACES" '
            # Split the comma-separated interface versions into an array (keep as strings)
            ($interfaces | split(",")) as $toc_versions |
            # Get matched versions (only from entries that have apiVersion)
            ([.[] | select(type == "object" and .apiVersion != null) | select(.apiVersion as $api | $toc_versions | index($api))]) as $matched |
            # Get the apiVersions that were matched
            ([$matched[].apiVersion]) as $matched_apis |
            # Find unmatched TOC versions
            ([$toc_versions[] | select(. as $v | $matched_apis | index($v) | not)]) as $unmatched |
            {
              gameVersions: [$matched[].id],
              unmatchedInterfaces: $unmatched
            }
          ')

          GAME_VERSIONS=$(echo "$RESULT" | jq -c '.gameVersions')
          UNMATCHED=$(echo "$RESULT" | jq -c '.unmatchedInterfaces')

          echo "Matched CurseForge game version IDs: $GAME_VERSIONS"

          # Fail if any TOC interface versions weren't mapped
          if [ "$UNMATCHED" != "[]" ]; then
            echo "::error::The following TOC interface versions have no matching CurseForge game version: $UNMATCHED"
            exit 1
          fi

          # Fail if no versions matched at all
          if [ "$GAME_VERSIONS" == "[]" ] || [ -z "$GAME_VERSIONS" ]; then
            echo "::error::No game versions matched from TOC interfaces: $TOC_INTERFACES"
            exit 1
          fi

          # Read changelog from file
          CHANGELOG=$(cat changelog.txt)

          # Create metadata JSON - escape the changelog for JSON
          CHANGELOG_JSON=$(echo "$CHANGELOG" | jq -Rs .)
          METADATA=$(jq -n \
            --argjson changelog "$CHANGELOG_JSON" \
            --arg displayName "${ADDON_NAME} ${{ steps.version.outputs.version }}" \
            --argjson gameVersions "$GAME_VERSIONS" \
            --arg releaseType "$RELEASE_TYPE" \
            '{
              changelog: $changelog,
              changelogType: "markdown",
              displayName: $displayName,
              gameVersions: $gameVersions,
              releaseType: $releaseType
            }'
          )

          # Upload to CurseForge
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "X-Api-Token: ${CF_TOKEN}" \
            -F "metadata=${METADATA}" \
            -F "file=@${ADDON_NAME}-${{ steps.version.outputs.version }}.zip" \
            "https://wow.curseforge.com/api/projects/${{ env.CF_PROJECT_ID }}/upload-file")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "CurseForge response: $BODY"
          
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::CurseForge upload failed with HTTP $HTTP_CODE: $BODY"
            exit 1
          fi
          
          echo "Successfully uploaded to CurseForge (HTTP $HTTP_CODE)"

      - name: Create GitHub Release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PRERELEASE_FLAG=""
          if [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          
          gh release create "$VERSION" \
            "${ADDON_NAME}-${VERSION}.zip" \
            --generate-notes \
            $PRERELEASE_FLAG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
